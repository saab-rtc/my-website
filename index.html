<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LSC Batch 02/2025 — Admit Card Portal</title>
  <meta name="description" content="Admit Card Download Portal — LSC Batch 02/2025" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

  <style>
    :root{
      --primary: #0f172a;
      --accent: #f59e0b;
      --muted: #94a3b8;
      --card: #0b1220;
      --white: #ffffff;
      --success: #10b981;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.04);
      --radius: 12px;
      font-family: 'Poppins', sans-serif;
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg,#07112a 0%, #071428 60%);
      color:var(--white);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px;
    }

    .container{
      width:100%;
      max-width:980px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }

    .header{
      background: linear-gradient(135deg,#0b2a6b, #07103a);
      padding:22px 28px;
      display:flex;
      gap:20px;
      align-items:center;
    }
    .brand {
      display:flex; gap:14px; align-items:center;
    }
    .logo{
      width:84px; height:84px; border-radius:10px; background:linear-gradient(180deg,#0f172a,#0a1b3d);
      display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px;
      border:1px solid rgba(255,255,255,0.05);
    }
    .titles h1{margin:0; font-size:1.25rem; letter-spacing:0.4px}
    .titles p{margin:0; color:var(--muted); font-size:0.9rem}

    .subtitle{
      padding:12px 20px;
      background: linear-gradient(90deg, rgba(245,158,11,0.15), rgba(245,158,11,0.07));
      color: var(--accent);
      font-weight:600;
      text-align:center;
    }

    .content{padding:22px;}
    .search-wrap{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; margin-bottom:14px;}
    .input {
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      padding:12px 14px;
      border-radius:8px;
      color:var(--white);
      width:320px;
      max-width:100%;
      font-size:1rem;
    }
    .btn {
      padding:11px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:0.98rem;
    }
    .btn-primary{
      background:linear-gradient(180deg,#1e3a8a,#163172);
      color:var(--white);
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
    }
    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(245,158,11,0.18);
    }

    .info {
      margin-top:18px;
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:10px;
      padding:18px;
      width:100%;
      box-shadow: 0 4px 20px rgba(2,6,23,0.5);
      border:1px solid rgba(255,255,255,0.03);
    }

    .message {
      text-align:center;
      padding:18px;
      color:var(--muted);
      font-weight:600;
    }
    .error { color: var(--danger); }
    .ok { color: var(--success); }

    .result-head{display:flex; gap:12px; align-items:center; margin-bottom:12px;}
    .result-head .icon{font-size:1.6rem}
    .meta-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-bottom:12px}
    .meta{background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; font-weight:600; color:var(--white)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:8px}

    .small{font-size:0.9rem; color:var(--muted)}

    .footer{
      padding:14px 18px;
      text-align:center;
      color:var(--muted);
      font-size:0.88rem;
    }

    .loading {
      width:20px; height:20px; border-radius:50%;
      border:3px solid rgba(255,255,255,0.08);
      border-top:3px solid var(--accent);
      animation:spin 1s linear infinite;
      display:inline-block;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* print adjustments for admit card download (download link only) */
    @media print{ .header,.subtitle,.search-wrap,.footer{display:none} }

    @media (max-width:600px){
      .brand .logo{width:60px;height:60px}
      .titles h1{font-size:1rem}
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="pageTitle">
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          LSC
        </div>
        <div class="titles">
          <h1 id="pageTitle">LSC Batch 02/2025 — Admit Card Portal</h1>
          <p>Recruit Training Center — Hyderabad</p>
        </div>
      </div>
      <div style="margin-left:auto; text-align:right;">
        <small class="small">System by: <strong>Mohsin Ali Jamali</strong></small>
      </div>
    </header>

    <div class="subtitle">Admit Card Distribution — Use CNIC to find and download</div>

    <main class="content" aria-live="polite">
      <div class="search-wrap" role="search" aria-label="Search admit card">
        <input id="cnicInput" class="input" type="text" inputmode="numeric"
               placeholder="Enter CNIC — 42201-1234567-9" maxlength="15" aria-label="Enter CNIC" />

        <button id="searchBtn" class="btn btn-primary" title="Search by CNIC">
          <i class="fas fa-search"></i> Search
        </button>

        <!-- Manual quick lookup by Roll No (fallback / convenience) -->
        <input id="rollInput" class="input" type="text" placeholder="Or enter Roll No (e.g. 277)" style="width:160px" />
        <button id="rollBtn" class="btn btn-ghost" title="Open by Roll No">
          <i class="fas fa-id-badge"></i> Open by Roll
        </button>
      </div>

      <div id="resultArea" class="info">
        <div class="card" id="cardMain">
          <div id="status" class="message">Enter CNIC above and press <strong>Search</strong>. (Admit cards must be uploaded to <code>/admitcards/</code> with names like <code>277-Asif Raza.pdf</code>.)</div>
        </div>
      </div>
    </main>

    <div class="footer">
      <div>Good luck to all trainees — LSC Batch 02/2025</div>
    </div>
  </div>

  <script>
    /*******************************************
     * CONFIG - set your SheetDB API here
     *******************************************/
    const SHEETDB_API = "https://sheetdb.io/api/v1/sh871nkwz39y0"; // replace if different
    const ADMIT_FOLDER = "/admitcards/"; // must be on same origin for HEAD-check to work

    /*******************************************
     * Helpers
     *******************************************/
    function normalizeCNIC(raw) {
      return (raw || "").replace(/\D/g, "");
    }

    function formatCNICDisplay(cnicDigits) {
      if (!cnicDigits) return "";
      const d = cnicDigits.replace(/\D/g, "");
      if (d.length !== 13) return cnicDigits;
      return `${d.slice(0,5)}-${d.slice(5,12)}-${d.slice(12)}`;
    }

    function sanitizeFilename(name){
      // keep human-readable spaces, but encode for URL
      return encodeURIComponent(name).replace(/%20/g, " ");
    }

    function showMessage(html, type = '') {
      const status = document.getElementById("status");
      status.className = "message";
      if (type === "error") status.classList.add("error");
      if (type === "ok") status.classList.add("ok");
      status.innerHTML = html;
    }

    function buildAdmitFilename(roll, name) {
      // Build filename exactly as you upload: "ROLL-Name.pdf"
      // Trim excessive spaces
      const cleanName = (name || "").trim().replace(/\s+/g, ' ');
      return `${roll}-${cleanName}.pdf`;
    }

    async function checkFileExists(url) {
      try {
        // Try HEAD first (fast, no body)
        const res = await fetch(url, { method: "HEAD", cache: "no-cache" });
        return res.ok;
      } catch (err) {
        // HEAD might be blocked by CORS; return null to indicate unknown
        return null;
      }
    }

    /*******************************************
     * Main search logic: search by CNIC using SheetDB
     *******************************************/
    document.getElementById("searchBtn").addEventListener("click", checkByCNIC);
    document.getElementById("cnicInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkByCNIC();
    });

    // Manual roll button (fallback) - constructs link from roll and tries to open (no SheetDB)
    document.getElementById("rollBtn").addEventListener("click", async () => {
      const roll = (document.getElementById("rollInput").value || "").trim();
      if (!roll) {
        showMessage("Please enter a Roll No to open admit card.", "error");
        return;
      }
      // Create a filename pattern: try to find file starting with roll (cannot read directory on static server)
      // We assume file named like `ROLL-First Last.pdf`. We'll try a HEAD request for a guessed filename
      // If you have standard naming pattern, you can put exact name here.
      showMessage(`<div style="display:flex;gap:10px;align-items:center;justify-content:center"><span class="loading"></span> Looking for admit card for roll <strong>${roll}</strong>...</div>`);
      // Without name we cannot build exact filename; so we will attempt a simple pattern: roll.pdf and roll-Name.pdf is unknown.
      // First try roll.pdf
      const try1 = ADMIT_FOLDER + encodeURIComponent(roll) + ".pdf";
      let exists = await checkFileExists(try1);
      if (exists === true) {
        openAdmitLink(try1, `${roll}.pdf`, true);
        return;
      }
      // If HEAD returned null (CORS), we will still open a link to ADMIT_FOLDER + roll + '.pdf' and inform user to verify
      if (exists === null) {
        showMessage(`Cannot verify file existence due to server CORS. Opening a best-effort link. If not found, upload admit card as <code>${roll}-Name.pdf</code> in <code>/admitcards/</code>.`);
        window.open(try1, "_blank");
        return;
      }
      // Not found
      showMessage(`Admit card not found for roll <strong>${roll}</strong>. Please ensure file is uploaded as <code>${roll}-Name.pdf</code> in <code>/admitcards/</code>.`, "error");
    });

    async function checkByCNIC(){
      const cnicInput = document.getElementById("cnicInput");
      const raw = cnicInput.value.trim();
      const cleaned = normalizeCNIC(raw);
      if (cleaned.length !== 13) {
        showMessage("Please enter a valid 13-digit CNIC (e.g., 42201-1234567-9).", "error");
        cnicInput.focus();
        return;
      }

      showMessage(`<div style="display:flex;gap:10px;align-items:center;justify-content:center"><span class="loading"></span> Searching for CNIC <strong>${formatCNICDisplay(cleaned)}</strong>…</div>`);

      try {
        // Query SheetDB for the record whose CNIC matches (SheetDB returns an array)
        // We use a simple fetch to the API and search client-side to be resilient to field names.
        const resp = await fetch(SHEETDB_API, { cache: "no-cache" });
        if (!resp.ok) throw new Error("Unable to fetch records from SheetDB.");
        const data = await resp.json();

        // Find a record where any CNIC-like field matches (strip non-digits)
        const trainee = data.find(rec => {
          // try common keys with flexible casing
          const possibleKeys = Object.keys(rec);
          for (let key of possibleKeys) {
            const val = (rec[key] || "").toString();
            if (val.replace(/\D/g,'') === cleaned) return true;
          }
          return false;
        });

        if (!trainee) {
          showMessage(`No trainee found for CNIC <strong>${formatCNICDisplay(cleaned)}</strong>. Please verify CNIC or use Roll No.`, "error");
          return;
        }

        // Obtain roll & name fields - try common column labels used previously
        const rollKeys = ["ROLL / SEAT NO", "ROLL/SEAT NO", "ROLL_NO", "ROLL", "Roll", "Roll No", "roll"];
        const nameKeys = ["NAME", "Name", "name", "TRAINEE NAME", "TRAINEE"];

        let roll = null, name = null;
        for (let k of rollKeys) if (trainee[k]) { roll = String(trainee[k]).trim(); break; }
        for (let k of nameKeys) if (trainee[k]) { name = String(trainee[k]).trim(); break; }

        if (!roll) {
          // fallback: maybe there is a 'RANK & B.No' containing roll at start
          if (trainee["RANK & B.No"]) {
            const val = String(trainee["RANK & B.No"]);
            const match = val.match(/\d+/);
            if (match) roll = match[0];
          }
        }
        if (!name) {
          // fallback to concatenating first/last if available
          if (trainee["FATHER'S NAME"]) name = String(trainee["NAME"] || trainee["NAME "] || "").trim();
        }

        if (!roll || !name) {
          // still missing - show found data for manual upload guidance
          let html = `<div class="result-head"><i class="fas fa-exclamation-triangle icon" style="color:var(--accent)"></i><div><strong>Partial record found</strong></div></div>`;
          html += `<div class="small">We found a record for this CNIC but couldn't detect both roll number and name automatically. Please check the SheetDB columns.</div>`;
          html += `<pre style="margin-top:10px; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; color:var(--muted)">${JSON.stringify(trainee, null, 2)}</pre>`;
          showMessage(html, "error");
          return;
        }

        // Build filename and check existence
        const filename = buildAdmitFilename(roll, name); // human readable
        const encodedURL = ADMIT_FOLDER + encodeURIComponent(filename);

        // Try HEAD to check existence
        let exists = await checkFileExists(encodedURL);
        if (exists === true) {
          // Show details and download button
          const html = `
            <div class="result-head">
              <i class="fas fa-id-card icon" style="color:var(--accent)"></i>
              <div>
                <div style="font-weight:700">${name}</div>
                <div class="small">Roll No: <strong>${roll}</strong> • CNIC: <strong>${formatCNICDisplay(cleaned)}</strong></div>
              </div>
            </div>
            <div class="meta-grid">
              <div class="meta">Arrival/Unit: ${trainee["ARRIVAL DIST. /UNIT"] || trainee["ARRIVAL DIST/UNIT"] || "—"}</div>
              <div class="meta">Rank/B.No: ${trainee["RANK & B.No"] || "—"}</div>
              <div class="meta">Status: <span style="color:var(--success); font-weight:700">Admit Card Ready</span></div>
            </div>
            <div class="actions">
              <a class="btn btn-primary" href="${encodedURL}" target="_blank" rel="noopener" download
                 title="Download Admit Card">
                <i class="fas fa-download"></i> Download Admit Card
              </a>
              <button class="btn btn-ghost" onclick="openAdmitLink('${encodedURL}','${filename}', true)">
                <i class="fas fa-eye"></i> Open in new tab
              </button>
              <button class="btn" style="background:transparent;color:var(--muted)" onclick="copyLink('${encodedURL}')">
                <i class="fas fa-link"></i> Copy Link
              </button>
            </div>
            <div class="small" style="margin-top:10px">If the file does not open, check that <code>/admitcards/${filename}</code> exists on the server.</div>
          `;
          showMessage(html, "ok");
          return;
        }

        if (exists === false) {
          // Not found: offer guidance and a fallback link (manual)
          const html = `
            <div class="result-head">
              <i class="fas fa-times-circle icon" style="color:var(--danger)"></i>
              <div>
                <div style="font-weight:700">${name}</div>
                <div class="small">Roll No: <strong>${roll}</strong> • CNIC: <strong>${formatCNICDisplay(cleaned)}</strong></div>
              </div>
            </div>
            <div style="margin-top:8px" class="small">Admit card not found on server as <code>${filename}</code>.</div>
            <div class="actions" style="margin-top:12px">
              <button class="btn btn-ghost" onclick="alert('Please upload the file as ${filename} into the /admitcards/ folder on your server.')">
                <i class="fas fa-upload"></i> Upload Missing File
              </button>
              <a class="btn" style="background:transparent;color:var(--muted)" href="${ADMIT_FOLDER + encodeURIComponent(filename)}" target="_blank" rel="noopener">
                <i class="fas fa-link"></i> Try open link anyway
              </a>
            </div>
          `;
          showMessage(html, "error");
          return;
        }

        // exists === null (couldn't verify HEAD due to CORS)
        const html = `
          <div class="result-head">
            <i class="fas fa-question-circle icon" style="color:var(--accent)"></i>
            <div>
              <div style="font-weight:700">${name}</div>
              <div class="small">Roll No: <strong>${roll}</strong> • CNIC: <strong>${formatCNICDisplay(cleaned)}</strong></div>
            </div>
          </div>
          <div class="small">Unable to verify file existence due to server restrictions (CORS). Click the link below to attempt opening the admit card. If it fails, ensure file is uploaded as <code>${filename}</code> inside <code>/admitcards/</code>.</div>
          <div class="actions" style="margin-top:12px">
            <a class="btn btn-primary" href="${encodedURL}" target="_blank" rel="noopener" download><i class="fas fa-download"></i> Open Admit Card</a>
            <button class="btn btn-ghost" onclick="alert('If opening fails, check server file: /admitcards/${filename}')">Help</button>
          </div>
        `;
        showMessage(html, "ok");

      } catch (err) {
        console.error(err);
        showMessage("Error contacting SheetDB. Please ensure your API URL is correct and the server is reachable. You can also use the Roll No quick-open as a fallback.", "error");
      }
    }

    function openAdmitLink(url, filename, newTab = false) {
      // Helper to open admit file. If newTab true open new tab.
      if (newTab) {
        window.open(url, "_blank", "noopener");
      } else {
        window.location.href = url;
      }
    }

    function copyLink(url) {
      navigator.clipboard?.writeText(url).then(() => {
        alert("Link copied to clipboard.");
      }).catch(() => {
        prompt("Copy this link:", url);
      });
    }

    // CNIC input formatting - adds dashes while typing
    const cnicEl = document.getElementById("cnicInput");
    cnicEl.addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g,'');
      if (v.length > 5) v = v.slice(0,5) + '-' + v.slice(5);
      if (v.length > 13+1) v = v.slice(0,13+1); // limit with dashes
      if (v.length > 13+1 && v.length <= 15) v = v.slice(0,13) + '-' + v.slice(13);
      // Reformat robustly:
      v = v.replace(/(^\d{5})(\d{7})(\d{1}$)/, '$1-$2-$3');
      e.target.value = v.slice(0,15);
    });

    // Optional: prefill with test CNIC in dev (comment out in production)
    // cnicEl.value = "42201-1234567-9";

  </script>
</body>
</html>
